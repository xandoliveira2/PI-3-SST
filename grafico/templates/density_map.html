{% extends "base.html" %}
{% load static %}


{% block 'filtro_veiculos' %}
<fieldset>
    <legend>Veículos</legend>
    <div class="wrapper v">
      <input type="checkbox" name="carros" id="carros">
      <p>Carros</p>
    </div>
    <div class="wrapper v">
      <input type="checkbox" name="motos" id="motos">
      <p>Motos</p>
    </div>
    <div class="wrapper v">
      <input type="checkbox" name="vans" id="vans" disabled>
      <p>Vans</p>
    </div>
    <div class="wrapper v">
      <input type="checkbox" name="caminhoes" id="caminhoes" disabled>
      <p>Caminhões</p>
    </div>
    <div class="wrapper v">
      <input type="checkbox" name="onibus" id="onibus" disabled>
      <p>Onibus</p>
    </div>
  </fieldset>

  <button class="botao" onclick="atualizarMapaComParametros()">Atualizar</button>
</div>
{% endblock %}

{% block 'data' %}
<div class="container">
    <div class="container-filtros">
      <div class="titulo-filtro">
        <img src="{% static 'imagens/icone-filtro.png' %}" alt="icone filtro">
        <h3>Filtros</h3>
      </div>
<fieldset>
    <legend>Data/Hora</legend>
    <div class="container-input">
      <div class="wrapper dataHora">
        <img src="{% static 'imagens/icone-calendario.png' %}" alt="icone calendario">
        <label for="data_form">Data</label>
      </div>
<select class="form-select" aria-label="Default select example" id="data_form" name="data_form"
style="width: fit-content;" onclick="atualizar_url1(); atualizar_horarios()">
<script>

    fetch('requisicao').then(response => response.json()).then( //http://localhost:8000/grafico/density-map/requisicao
        data => { 
            const select_dia = document.getElementById('data_form');
            data.dados.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item;      
                        option.textContent = item; 
                        select_dia.appendChild(option); 
                    });
                }).catch(
                    error => console.error('Erro:', error));
    
    
    </script>
</select>
</div>
{% endblock%}

{% block 'filtro_data' %}
<div class="container-input">
    <div class="wrapper data-hora">
      <img src="{% static 'imagens/icone-relogio.png' %}" alt="icone relogio">
      <label for="hour_form">Hora</label>
    </div>
<select class="form-select" aria-label="Default select example" id="hour_form" name="hour_form"
style="width: fit-content;" onclick="atualizar_url1()" onload="selecionarHora()">
<script>
    document.addEventListener("DOMContentLoaded", evento =>{
        let ajaxExecuted = false;
        const horas = {'horas':document.getElementById('hour_form').value}
        const data= document.getElementById('data_form').value; 

      
        console.log(horas);
        const urlParams = new URLSearchParams(window.location.search);


        const param2 = urlParams.get('param2');
    fetch(`requisicao/horarios?param1=${data}`)
    .then(response => {
        if (!response.ok) {
            throw new Error(`Erro na rede: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => { 
        
        select_hora = document.getElementById('hour_form');
        
        data.horas.forEach(item => {
            const option = document.createElement('option');
            option.value = item;      
            option.textContent = item; 
            select_hora.appendChild(option); 
        });
        
      
        const hora = param2
        document.getElementById('hour_form').value = param2
       
          
        const data1= document.getElementById('data_form').value; 
        const url = `/grafico/density-map/?param1=${data1}&param2=${hora}`;
        

    })
    .catch(error => console.error('Erro:', error));
    
});


    function atualizar_horarios(){
        const urlParams = new URLSearchParams(window.location.search);
        const param2Value = urlParams.get("param2");
        const data_formulario = document.getElementById('data_form').value;
        fetch(`requisicao/horarios?param1=${data_formulario}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro na rede: ${response.statusText}`);
            }
            return response.json();
        })
    .then(data => { 
       
        select_hora = document.getElementById('hour_form');
        while (select_hora.firstChild){
            select_hora.removeChild(select_hora.firstChild);
        }
        data.horas.forEach(item => {
            const option = document.createElement('option');
            option.value = item;      
            option.textContent = item; 
            select_hora.appendChild(option); 
        });
        document.getElementById('hour_form').value = param2Value;

    })}

      
        
        
    function atualizar_url1(){
        
    $('#hour_form , #data_form').click(function() {
                const dado = document.getElementById('data_form').value;  
                const hora = document.getElementById('hour_form').value;
              
                const url = `/grafico/density-map/?param1=${dado}&param2=${hora}`  
    
                $.ajax({
                    url: url,
                    type: 'GET',
                 
                    success: function(response) {
                        window.history.pushState({path : url},'',url)
                    },
                    error: function(xhr, status, error) {
                     
                        console.error("Erro:", error);
                    }
                });
            });
    
        }
        function atualizarMapaComParametros(){
            if (!document.getElementById("carros").checked &&
            !document.getElementById("motos").checked&&
            !document.getElementById("vans").checked &&
            !document.getElementById("caminhoes").checked &&
            !document.getElementById("onibus").checked){
                alert("Selecione ao menos 1 tipo de veículo")
            }  else {


            const data = document.getElementById('data_form').value;
            const hora = document.getElementById('hour_form').value;
            let filtros = "";
if (document.getElementById("carros").checked){
    filtros += document.getElementById("carros").id + '%20'; 
}
if (document.getElementById("motos").checked){
    filtros += document.getElementById("motos").id + '%20';
}
if (document.getElementById("vans").checked){
    filtros += document.getElementById("vans").id + '%20';
}
if (document.getElementById("caminhoes").checked){
    filtros += document.getElementById("caminhoes").id + '%20';
}
if (document.getElementById("onibus").checked){
    filtros += document.getElementById("onibus").id + '%20';
}


filtros = filtros.trim(); // Remove o espaço ou '%20' extra no final, se houver

// Criação da URL
const url = `http://localhost:8000/grafico/density-map/?param1=${data}&param2=${hora}&param3=${filtros}`;
window.location.href = url;


// let arraysplit = filtros.split("%20");
// console.log(arraysplit)
// arraysplit.forEach(element => {
//     if (element) { 
//         switch (element) {
//             case "carros":
//                 document.getElementById(element).checked = true;
//                 break;
//             case "motos":
//                 document.getElementById(element).checked = true;
//                 break;
//             case "vans":
//                 document.getElementById(element).checked = true;
//                 break;
//             case "caminhoes":
//                 document.getElementById(element).checked = true;
//                 break;
//             case "onibus":
//                 document.getElementById(element).checked = true;
//                 break;
//             default:
//                 break;
//         }
//     }
// });
        }}
    </script>

</select>
</div>
</fieldset>
{% endblock %}




{% block 'colorConfiguration' %}
<fieldset>
    <legend>Configuração Cores</legend>
    <div class="configuracao">
      <div class="container-cores">
        <div class="container-input">
          <label for="vermelho">Vermelho:</label>
          <div class="wrapper">
            <img src="{% static 'imagens/Ellipse-vermelho.png' %}" alt="">
            <input type="text" id="vermelho" name="vermelho">
          </div>
          
        </div>
        <div class="container-input">
          <label for="laranja">Laranja:</label>
          <div class="wrapper">
            <img src="{% static 'imagens/Ellipse-laranja.png' %}" alt="">
            <input type="text" id="laranja" name="laranja">
          </div>
        </div>
        <div class="container-input">
          <label for="amarelo">Amarelo:</label>
          <div class="wrapper">
            <img src="{% static 'imagens/Ellipse-amarelo.png' %}" alt="">
            <input type="text" id="amarelo" name="amarelo">
          </div>
        </div>
        <div class="container-input">
          <label for="azul">Azul:</label>
          <div class="wrapper">
            <img src="{% static 'imagens/Ellipse-azul.png' %}" alt="">
            <input type="text" id="azul" name="azul">
          </div>
        </div>
        <div class="container-input">
          <label for="verde">Verde:</label>
          <div class="wrapper">
            <img src="{% static 'imagens/Ellipse-verde.png' %}" alt="">
            <input type="text" id="verde" name="verde" disabled value="Verde < Azul">
          </div>
        </div>
      </div>
      
      <button class="botao" onclick="atualizarCores()">Atualizar cores</button>
    </div>
  </fieldset>

<script>
    function atualizarCores(){
        
    if (document.getElementById('vermelho').value &&
     document.getElementById('laranja').value && 
     document.getElementById('amarelo').value && 
     document.getElementById('azul').value
     )
     {
        let urlParams = new URLSearchParams(window.location.search);
        let atualUrl = window.location.href
        dados = document.getElementById('vermelho').value + "_" + document.getElementById('laranja').value  + "_" + document.getElementById('amarelo').value + "_" + document.getElementById('azul').value;
        let urlDestino = ''
        let novaUrl = new URL(atualUrl);
        if (novaUrl.search.includes('param4')) {
        urlParams.set("param4", decodeURIComponent(dados)); 
        novaUrl.search = urlParams.toString(); 
        urlDestino = novaUrl.toString(); 
        

        }else{
        urlDestino = atualUrl+`&param4=${dados}`
        
       
        }
       
        console.log(urlDestino)
        
        
        window.location.href = urlDestino
     }else{
        alert("Preencha todos os campos")
     }
    }
</script>


{% endblock %}


{% block 'dashboard1' %}
   

{{ grafico_html|safe }}


{% endblock %}
